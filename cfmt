#!/bin/bash

# C/C++ãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# clang-formatã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’æ•´å½¢ã—ã€å‡¦ç†ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™

# ã‚«ãƒ©ãƒ¼å®šç¾©
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly YELLOW='\033[1;33m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color
readonly BOLD='\033[1m'

# ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©
readonly CHECK="âœ“"
readonly CROSS="âœ—"
readonly ARROW="â†’"
readonly FOLDER="ðŸ“"
readonly FILE="ðŸ“„"

# çµ±è¨ˆæƒ…å ±
total_files=0
formatted_files=0
failed_files=0

# clang-formatã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
clang_format_style=""

# ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿
load_format_style() {
    local cfmt_file=".cfmt"
    
    echo -e "${BLUE}${BOLD}=== ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š ===${NC}"
    
    if [[ -f "$cfmt_file" ]]; then
        # .cfmtãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
        local style_content=$(cat "$cfmt_file" 2>/dev/null | tr -d '\n\r' | sed 's/[[:space:]]*$//')
        
        if [[ -n "$style_content" ]]; then
            clang_format_style="$style_content"
            echo -e "${GREEN}${CHECK} .cfmtãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ${NC}"
            echo -e "${CYAN}  ã‚¹ã‚¿ã‚¤ãƒ«: ${BOLD}$clang_format_style${NC}"
        else
            echo -e "${YELLOW}${CROSS} .cfmtãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨${NC}"
            clang_format_style="LLVM"
        fi
    else
        # .cfmtãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆ
        echo -e "${YELLOW}${CROSS} .cfmtãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨${NC}"
        echo -e "${CYAN}  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«: ${BOLD}LLVM${NC}"
        echo -e "${YELLOW}  ãƒ’ãƒ³ãƒˆ: .cfmtãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æŒ‡å®šã§ãã¾ã™${NC}"
        echo -e "${YELLOW}    ä¾‹: echo 'Google' > .cfmt${NC}"
        echo -e "${YELLOW}    åˆ©ç”¨å¯èƒ½ã‚¹ã‚¿ã‚¤ãƒ«: LLVM, GNU, Google, Chromium, Microsoft, Mozilla, WebKit${NC}"
        clang_format_style="LLVM"
    fi
    
    # .clang-formatãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚‚ãƒã‚§ãƒƒã‚¯
    if [[ -f ".clang-format" ]] || [[ -f "_clang-format" ]]; then
        echo -e "${BLUE}${ARROW} .clang-formatãƒ•ã‚¡ã‚¤ãƒ«ã‚‚æ¤œå‡ºã•ã‚Œã¾ã—ãŸ (ã“ã¡ã‚‰ãŒå„ªå…ˆã•ã‚Œã¾ã™)${NC}"
    fi
    
    echo
}
check_dependencies() {
    echo -e "${BLUE}${BOLD}=== ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ ===${NC}"
    
    if ! command -v clang-format >/dev/null 2>&1; then
        echo -e "${RED}${CROSS} clang-formatãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}" >&2
        echo -e "${YELLOW}  ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•:${NC}"
        echo -e "    Ubuntu/Debian: ${CYAN}sudo apt install clang-format${NC}"
        echo -e "    CentOS/RHEL:   ${CYAN}sudo yum install clang-tools-extra${NC}"
        echo -e "    macOS:         ${CYAN}brew install clang-format${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}${CHECK} clang-format: $(clang-format --version | head -n1)${NC}"
    
    if command -v tree >/dev/null 2>&1; then
        echo -e "${GREEN}${CHECK} tree: $(tree --version | head -n1)${NC}"
        echo
        return 0
    else
        echo -e "${YELLOW}${CROSS} tree ã‚³ãƒžãƒ³ãƒ‰ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)${NC}"
        echo
        return 1
    fi
}

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’è¡¨ç¤º
show_directory_structure() {
    local target_dir="$1"
    local has_tree="$2"
    
    echo -e "${BLUE}${BOLD}=== ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€  ===${NC}"
    
    if [[ ! -d "$target_dir" ]]; then
        echo -e "${RED}${CROSS} ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª '$target_dir' ãŒå­˜åœ¨ã—ã¾ã›ã‚“${NC}" >&2
        return 1
    fi
    
    if [[ $has_tree -eq 1 ]]; then
        tree "$target_dir" 2>/dev/null || echo -e "${FOLDER} $target_dir/"
    else
        echo -e "${FOLDER} $target_dir/"
        find "$target_dir" -type f \( -name "*.c" -o -name "*.cpp" -o -name "*.cxx" -o -name "*.cc" -o -name "*.C" -o -name "*.h" -o -name "*.hpp" -o -name "*.hxx" \) 2>/dev/null | \
            head -10 | sed "s|^|  ${ARROW} |"
        local count=$(find "$target_dir" -type f \( -name "*.c" -o -name "*.cpp" -o -name "*.cxx" -o -name "*.cc" -o -name "*.C" -o -name "*.h" -o -name "*.hpp" -o -name "*.hxx" \) 2>/dev/null | wc -l)
        if [[ $count -gt 10 ]]; then
            echo -e "  ${ARROW} ... and $((count - 10)) more files"
        fi
    fi
    echo
}

# å†å¸°çš„ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
format_directory() {
    local target_dir="$1"
    local base_dir="$(cd "$target_dir" && pwd)"
    
    echo -e "${BLUE}${BOLD}=== ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå®Ÿè¡Œ ===${NC}"
    echo -e "${CYAN}å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $target_dir${NC}"
    echo
    
    # findã§å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã¦ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
    while IFS= read -r -d '' file; do
        ((total_files++))
        
        local relative_path="${file#$base_dir/}"
        echo -n "Processing: $relative_path ... "
        
        # ã‚¹ã‚¿ã‚¤ãƒ«æŒ‡å®šã§clang-formatã‚’å®Ÿè¡Œ
        local format_cmd="clang-format -i"
        if [[ -n "$clang_format_style" ]] && [[ ! -f ".clang-format" ]] && [[ ! -f "_clang-format" ]]; then
            format_cmd="clang-format -i -style=$clang_format_style"
        fi
        
        if eval "$format_cmd \"$file\"" 2>/dev/null; then
            ((formatted_files++))
            echo -e "${GREEN}${CHECK} Success${NC}"
        else
            ((failed_files++))
            echo -e "${RED}${CROSS} Failed${NC}"
        fi
    done < <(find "$target_dir" -type f \( \
        -name "*.c" -o \
        -name "*.cpp" -o \
        -name "*.cxx" -o \
        -name "*.cc" -o \
        -name "*.C" -o \
        -name "*.h" -o \
        -name "*.hpp" -o \
        -name "*.hxx" \
    \) -print0 2>/dev/null)
    
    echo
}

# çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
show_statistics() {
    echo -e "${BLUE}${BOLD}=== ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆçµæžœ ===${NC}"
    echo -e "${CYAN}å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${BOLD}$total_files${NC}"
    echo -e "${GREEN}æˆåŠŸ:         ${BOLD}$formatted_files${NC}"
    
    if [[ $failed_files -gt 0 ]]; then
        echo -e "${RED}å¤±æ•—:         ${BOLD}$failed_files${NC}"
    fi
    
    if [[ $total_files -eq 0 ]]; then
        echo -e "${YELLOW}${ARROW} å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ${NC}"
        echo -e "${YELLOW}${ARROW} å¯¾è±¡æ‹¡å¼µå­: .c, .cpp, .cxx, .cc, .C, .h, .hpp, .hxx${NC}"
    elif [[ $formatted_files -eq $total_files ]]; then
        echo -e "${GREEN}${CHECK} ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã•ã‚Œã¾ã—ãŸï¼${NC}"
    fi
    echo
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
		if [[ "$#" -eq 0 ]]; then
        echo -e "${RED}${CROSS} ã‚¨ãƒ©ãƒ¼: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“${NC}" >&2
        echo -e "${YELLOW}${ARROW} ä½¿ç”¨æ–¹æ³•: $0 [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå]${NC}" >&2
        echo -e "${YELLOW}${ARROW} ä¾‹: $0 src${NC}" >&2
        exit 1
		fi
		target_dir="$1"
    
    echo -e "${BOLD}${CYAN}C/C++ Code Formatter${NC}"
    echo -e "${CYAN}=====================${NC}"
    echo
    
    # ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿
    load_format_style
    
    # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    local has_tree=0
    if check_dependencies; then
        has_tree=1
    fi
    
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$target_dir" ]]; then
        echo -e "${RED}${CROSS} ã‚¨ãƒ©ãƒ¼: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª '$target_dir' ãŒå­˜åœ¨ã—ã¾ã›ã‚“${NC}" >&2
        echo -e "${YELLOW}${ARROW} ä½¿ç”¨æ–¹æ³•: $0 [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå]${NC}" >&2
        echo -e "${YELLOW}${ARROW} ä¾‹: $0 src${NC}" >&2
        exit 1
    fi
    
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ è¡¨ç¤º
    show_directory_structure "$target_dir" "$has_tree"
    
    # ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå®Ÿè¡Œ
    format_directory "$target_dir"
    
    # çµ±è¨ˆæƒ…å ±è¡¨ç¤º
    show_statistics
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"

