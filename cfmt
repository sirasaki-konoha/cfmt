#!/bin/bash

# C/C++ãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰å¯¾å¿œï¼‰
# clang-formatã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’æ•´å½¢ã—ã€å‡¦ç†ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™

# ã‚«ãƒ©ãƒ¼å®šç¾©
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly YELLOW='\033[1;33m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color
readonly BOLD='\033[1m'

# ã‚¢ã‚¤ã‚³ãƒ³å®šç¾©
readonly CHECK="âœ“"
readonly CROSS="âœ—"
readonly ARROW="â†’"
readonly FOLDER="ğŸ“"
readonly FILE="ğŸ“„"

# çµ±è¨ˆæƒ…å ±ï¼ˆä¸¦è¡Œå‡¦ç†ç”¨ã«ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
readonly STATS_DIR="/tmp/cfmt_$$"
readonly TOTAL_FILE="$STATS_DIR/total"
readonly SUCCESS_FILE="$STATS_DIR/success"
readonly FAILED_FILE="$STATS_DIR/failed"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸¦åˆ—å‡¦ç†æ•°ï¼ˆCPUã‚³ã‚¢æ•°ï¼‰
readonly DEFAULT_JOBS=$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo "4")

# clang-formatã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
clang_format_style=""
jobs="$DEFAULT_JOBS"

# çµ±è¨ˆæƒ…å ±ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
init_stats() {
    mkdir -p "$STATS_DIR"
    echo "0" > "$TOTAL_FILE"
    echo "0" > "$SUCCESS_FILE"
    echo "0" > "$FAILED_FILE"
}

# çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ï¼ˆã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œï¼‰
increment_stat() {
    local stat_file="$1"
    local count
    (
        flock -x 200
        count=$(cat "$stat_file" 2>/dev/null || echo "0")
        echo $((count + 1)) > "$stat_file"
    ) 200>"$stat_file.lock"
}

# çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
get_stat() {
    cat "$1" 2>/dev/null || echo "0"
}

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
cleanup() {
    rm -rf "$STATS_DIR"
}

# ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿
load_format_style() {
    local cfmt_file=".cfmt"

    echo -e "${BLUE}${BOLD}=== ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š ===${NC}"

    if [[ -f "$cfmt_file" ]]; then
        # .cfmtãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
        local style_content=$(cat "$cfmt_file" 2>/dev/null | tr -d '\n\r' | sed 's/[[:space:]]*$//')

        if [[ -n "$style_content" ]]; then
            clang_format_style="$style_content"
            echo -e "${GREEN}${CHECK} .cfmtãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ${NC}"
            echo -e "${CYAN}  ã‚¹ã‚¿ã‚¤ãƒ«: ${BOLD}$clang_format_style${NC}"
        else
            echo -e "${YELLOW}${CROSS} .cfmtãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨${NC}"
            clang_format_style="Google"
        fi
    else
        # .cfmtãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆ
        echo -e "${YELLOW}${CROSS} .cfmtãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨${NC}"
        echo -e "${CYAN}  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«: ${BOLD}Google${NC}"
        echo -e "${YELLOW}  ãƒ’ãƒ³ãƒˆ: .cfmtãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æŒ‡å®šã§ãã¾ã™${NC}"
        echo -e "${YELLOW}    ä¾‹: echo 'LLVM' > .cfmt${NC}"
        echo -e "${YELLOW}    åˆ©ç”¨å¯èƒ½ã‚¹ã‚¿ã‚¤ãƒ«: LLVM, GNU, Google, Chromium, Microsoft, Mozilla, WebKit${NC}"
        clang_format_style="Google"
    fi

    # .clang-formatãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚‚ãƒã‚§ãƒƒã‚¯
    if [[ -f ".clang-format" ]] || [[ -f "_clang-format" ]]; then
        echo -e "${BLUE}${ARROW} .clang-formatãƒ•ã‚¡ã‚¤ãƒ«ã‚‚æ¤œå‡ºã•ã‚Œã¾ã—ãŸ (ã“ã¡ã‚‰ãŒå„ªå…ˆã•ã‚Œã¾ã™)${NC}"
    fi

    echo
}

check_dependencies() {
    echo -e "${BLUE}${BOLD}=== ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ ===${NC}"

    if ! command -v clang-format >/dev/null 2>&1; then
        echo -e "${RED}${CROSS} clang-formatãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}" >&2
        echo -e "${YELLOW}  ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•:${NC}"
        echo -e "    Ubuntu/Debian: ${CYAN}sudo apt install clang-format${NC}"
        echo -e "    CentOS/RHEL:   ${CYAN}sudo yum install clang-tools-extra${NC}"
        echo -e "    macOS:         ${CYAN}brew install clang-format${NC}"
        exit 1
    fi

    echo -e "${GREEN}${CHECK} clang-format: $(clang-format --version | head -n1)${NC}"
    echo -e "${GREEN}${CHECK} ä¸¦åˆ—å‡¦ç†æ•°: ${BOLD}$jobs${NC} jobs"

    # GNU parallelã®ä½¿ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
    if command -v parallel >/dev/null 2>&1; then
        echo -e "${GREEN}${CHECK} GNU parallel: $(parallel --version | head -n1)${NC}"
        echo -e "${CYAN}  ${ARROW} GNU parallelã‚’ä½¿ç”¨ã—ã¦é«˜é€Ÿå‡¦ç†ã—ã¾ã™${NC}"
    else
        echo -e "${YELLOW}${CROSS} GNU parallel ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“${NC}"
        echo -e "${CYAN}  ${ARROW} Bashã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã‚’ä½¿ç”¨ã—ã¾ã™${NC}"
        echo -e "${YELLOW}  ã‚ˆã‚Šé«˜é€ŸåŒ–ã™ã‚‹ã«ã¯: ${CYAN}sudo apt install parallel${NC} ã¾ãŸã¯ ${CYAN}brew install parallel${NC}"
    fi

    if command -v tree >/dev/null 2>&1; then
        echo -e "${GREEN}${CHECK} tree: $(tree --version | head -n1)${NC}"
        echo
        return 0
    else
        echo -e "${YELLOW}${CROSS} tree ã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)${NC}"
        echo
        return 1
    fi
}

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’è¡¨ç¤º
show_directory_structure() {
    local target_dir="$1"
    local has_tree="$2"

    echo -e "${BLUE}${BOLD}=== ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€  ===${NC}"

    if [[ ! -d "$target_dir" ]]; then
        echo -e "${RED}${CROSS} ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª '$target_dir' ãŒå­˜åœ¨ã—ã¾ã›ã‚“${NC}" >&2
        return 1
    fi

    if [[ $has_tree -eq 1 ]]; then
        tree -P "*.c" -P "*.cpp" -P "*.cxx" -P "*.cc" -P "*.C" -P "*.h" -P "*.hpp" -P "*.hxx" "$target_dir" 2>/dev/null || echo -e "${FOLDER} $target_dir/"
    else
        echo -e "${FOLDER} $target_dir/"
        find "$target_dir" -type f \( -name "*.c" -o -name "*.cpp" -o -name "*.cxx" -o -name "*.cc" -o -name "*.C" -o -name "*.h" -o -name "*.hpp" -o -name "*.hxx" \) 2>/dev/null |
            head -10 | sed "s|^|  ${ARROW} |"
        local count=$(find "$target_dir" -type f \( -name "*.c" -o -name "*.cpp" -o -name "*.cxx" -o -name "*.cc" -o -name "*.C" -o -name "*.h" -o -name "*.hpp" -o -name "*.hxx" \) 2>/dev/null | wc -l)
        if [[ $count -gt 10 ]]; then
            echo -e "  ${ARROW} ... and $((count - 10)) more files"
        fi
    fi
    echo
}

# å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãƒ¯ãƒ¼ã‚«ãƒ¼é–¢æ•°ï¼‰
format_single_file() {
    local file="$1"
    local base_dir="$2"
    local style="$3"
    
    increment_stat "$TOTAL_FILE"
    
    local relative_path="${file#$base_dir/}"
    
    # ã‚¹ã‚¿ã‚¤ãƒ«æŒ‡å®šã§clang-formatã‚’å®Ÿè¡Œ
    local format_cmd="clang-format -i"
    if [[ -n "$style" ]] && [[ ! -f ".clang-format" ]] && [[ ! -f "_clang-format" ]]; then
        format_cmd="clang-format -i -style=$style"
    fi

    if eval "$format_cmd \"$file\"" 2>/dev/null; then
        increment_stat "$SUCCESS_FILE"
        echo -e "Processing: $relative_path ... ${GREEN}${CHECK} Success${NC}"
    else
        increment_stat "$FAILED_FILE"
        echo -e "Processing: $relative_path ... ${RED}${CROSS} Failed${NC}"
    fi
}

# GNU parallelã‚’ä½¿ç”¨ã—ãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
format_with_parallel() {
    local target_dir="$1"
    local base_dir="$(cd "$target_dir" && pwd)"

    echo -e "${BLUE}${BOLD}=== ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Ÿè¡Œï¼ˆGNU parallelä½¿ç”¨ï¼‰ ===${NC}"
    echo -e "${CYAN}å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $target_dir${NC}"
    echo -e "${CYAN}ä¸¦åˆ—å‡¦ç†æ•°: $jobs${NC}"
    echo

    export -f format_single_file increment_stat get_stat
    export RED GREEN BLUE YELLOW CYAN NC BOLD CHECK CROSS ARROW
    export STATS_DIR TOTAL_FILE SUCCESS_FILE FAILED_FILE

    find "$target_dir" -type f \( \
        -name "*.c" -o \
        -name "*.cpp" -o \
        -name "*.cxx" -o \
        -name "*.cc" -o \
        -name "*.C" -o \
        -name "*.h" -o \
        -name "*.hpp" -o \
        -name "*.hxx" \
        \) -print0 2>/dev/null | \
    parallel -0 -j "$jobs" format_single_file {} "$base_dir" "$clang_format_style"
    
    echo
}

# Bashã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã‚’ä½¿ç”¨ã—ãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
format_with_bash() {
    local target_dir="$1"
    local base_dir="$(cd "$target_dir" && pwd)"

    echo -e "${BLUE}${BOLD}=== ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Ÿè¡Œï¼ˆBashä¸¦åˆ—å‡¦ç†ï¼‰ ===${NC}"
    echo -e "${CYAN}å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $target_dir${NC}"
    echo -e "${CYAN}ä¸¦åˆ—å‡¦ç†æ•°: $jobs${NC}"
    echo

    local file_count=0
    local job_count=0

    while IFS= read -r -d '' file; do
        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        format_single_file "$file" "$base_dir" "$clang_format_style" &
        
        ((file_count++))
        ((job_count++))
        
        # æŒ‡å®šã•ã‚ŒãŸä¸¦åˆ—æ•°ã«é”ã—ãŸã‚‰å¾…æ©Ÿ
        if [[ $job_count -ge $jobs ]]; then
            wait
            job_count=0
        fi
    done < <(find "$target_dir" -type f \( \
        -name "*.c" -o \
        -name "*.cpp" -o \
        -name "*.cxx" -o \
        -name "*.cc" -o \
        -name "*.C" -o \
        -name "*.h" -o \
        -name "*.hpp" -o \
        -name "*.hxx" \
        \) -print0 2>/dev/null)

    # æ®‹ã‚Šã®ã‚¸ãƒ§ãƒ–ã‚’å¾…æ©Ÿ
    wait
    echo
}

# çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
show_statistics() {
    local total_files=$(get_stat "$TOTAL_FILE")
    local formatted_files=$(get_stat "$SUCCESS_FILE")
    local failed_files=$(get_stat "$FAILED_FILE")

    echo -e "${BLUE}${BOLD}=== ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆçµæœ ===${NC}"
    echo -e "${CYAN}å‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${BOLD}$total_files${NC}"
    echo -e "${GREEN}æˆåŠŸ:         ${BOLD}$formatted_files${NC}"

    if [[ $failed_files -gt 0 ]]; then
        echo -e "${RED}å¤±æ•—:         ${BOLD}$failed_files${NC}"
    fi

    if [[ $total_files -eq 0 ]]; then
        echo -e "${YELLOW}${ARROW} å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ${NC}"
        echo -e "${YELLOW}${ARROW} å¯¾è±¡æ‹¡å¼µå­: .c, .cpp, .cxx, .cc, .C, .h, .hpp, .hxx${NC}"
    elif [[ $formatted_files -eq $total_files ]]; then
        echo -e "${GREEN}${CHECK} ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¾ã—ãŸï¼${NC}"
    fi
    echo
}

# ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
show_help() {
    echo -e "${BOLD}${CYAN}C/C++ Code Formatter (ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰å¯¾å¿œ)${NC}"
    echo -e "${CYAN}============================================${NC}"
    echo
    echo -e "${BOLD}ä½¿ç”¨æ–¹æ³•:${NC}"
    echo -e "  $0 [OPTIONS] DIRECTORY"
    echo
    echo -e "${BOLD}ã‚ªãƒ—ã‚·ãƒ§ãƒ³:${NC}"
    echo -e "  -j, --jobs NUM     ä¸¦åˆ—å‡¦ç†æ•°ã‚’æŒ‡å®š (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: $DEFAULT_JOBS)"
    echo -e "  -h, --help         ã“ã®ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º"
    echo
    echo -e "${BOLD}ä¾‹:${NC}"
    echo -e "  $0 src                    # srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’$DEFAULT_JOBSä¸¦åˆ—ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
    echo -e "  $0 -j 8 src              # srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’8ä¸¦åˆ—ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
    echo -e "  $0 --jobs 2 ./project    # projectãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’2ä¸¦åˆ—ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
    echo
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    # å¼•æ•°è§£æ
    while [[ $# -gt 0 ]]; do
        case $1 in
            -j|--jobs)
                if [[ -n "$2" ]] && [[ "$2" =~ ^[0-9]+$ ]] && [[ "$2" -gt 0 ]]; then
                    jobs="$2"
                    shift 2
                else
                    echo -e "${RED}${CROSS} ã‚¨ãƒ©ãƒ¼: --jobs ã«ã¯æ­£ã®æ•´æ•°ã‚’æŒ‡å®šã—ã¦ãã ã•ã„${NC}" >&2
                    exit 1
                fi
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            -*)
                echo -e "${RED}${CROSS} ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ '$1'${NC}" >&2
                show_help
                exit 1
                ;;
            *)
                target_dir="$1"
                shift
                ;;
        esac
    done

    if [[ -z "$target_dir" ]]; then
        echo -e "${RED}${CROSS} ã‚¨ãƒ©ãƒ¼: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“${NC}" >&2
        show_help
        exit 1
    fi

    echo -e "${BOLD}${CYAN}C/C++ Code Formatter (ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰å¯¾å¿œ)${NC}"
    echo -e "${CYAN}============================================${NC}"
    echo

    # çµ±è¨ˆæƒ…å ±ã‚’åˆæœŸåŒ–
    init_stats
    trap cleanup EXIT

    # ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿
    load_format_style

    # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    local has_tree=0
    if check_dependencies; then
        has_tree=1
    fi

    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
    if [[ ! -d "$target_dir" ]]; then
        echo -e "${RED}${CROSS} ã‚¨ãƒ©ãƒ¼: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª '$target_dir' ãŒå­˜åœ¨ã—ã¾ã›ã‚“${NC}" >&2
        exit 1
    fi

    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ è¡¨ç¤º
    show_directory_structure "$target_dir" "$has_tree"

    # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Ÿè¡Œï¼ˆparallelãŒåˆ©ç”¨å¯èƒ½ã‹ã©ã†ã‹ã§åˆ†å²ï¼‰
    if command -v parallel >/dev/null 2>&1; then
        format_with_parallel "$target_dir"
    else
        format_with_bash "$target_dir"
    fi

    # çµ±è¨ˆæƒ…å ±è¡¨ç¤º
    show_statistics
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"

